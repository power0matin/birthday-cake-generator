name: Refresh live screenshot

on:
  schedule:
    - cron: "0 0 1 * *"   # Every month (at 00:00 on day 1)
  workflow_dispatch: {}
  push:
    paths:
      - ".github/workflows/refresh-screenshot.yml"

concurrency:
  group: refresh-screenshot-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  shot:
    runs-on: ubuntu-latest

    env:
      TARGET_URL: "https://power0matin.github.io/birthday-cake-generator/"
      OUTPUT_PATH: "assets/birthday-cake-preview.png"
      VIEWPORT_WIDTH: "1920"
      VIEWPORT_HEIGHT: "1080"
      DEVICE_SCALE_FACTOR: "2" # اگر شارپ‌تر خواستی 2 کن (حجم فایل بیشتر می‌شود)
      WAIT_MS: "1500"
      NAV_TIMEOUT_MS: "45000"
      RETRIES: "3"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright (Chromium only)
        run: |
          npm i -D playwright@^1
          npx playwright install --with-deps chromium

      - name: Ensure assets dir exists
        run: mkdir -p "$(dirname "$OUTPUT_PATH")"

      - name: Write screenshot script
        shell: bash
        run: |
          mkdir -p scripts
          cat > scripts/snap.mjs << 'EOF'
          import { chromium } from 'playwright';

          const url = process.env.TARGET_URL;
          const out = process.env.OUTPUT_PATH;

          const vw  = parseInt(process.env.VIEWPORT_WIDTH  || '1920', 10);
          const vh  = parseInt(process.env.VIEWPORT_HEIGHT || '1080', 10);
          const dpr = parseFloat(process.env.DEVICE_SCALE_FACTOR || '2');

          const waitMs  = parseInt(process.env.WAIT_MS || '1500', 10);
          const navTO   = parseInt(process.env.NAV_TIMEOUT_MS || '45000', 10);
          const retries = parseInt(process.env.RETRIES || '3', 10);

          if (!url || !out) {
            console.error('TARGET_URL or OUTPUT_PATH missing');
            process.exit(2);
          }

          const attempt = async (tryNo) => {
            const browser = await chromium.launch({
              headless: true,
              args: [
                '--force-color-profile=srgb',
                `--window-size=${vw},${vh}`
              ],
            });

            const context = await browser.newContext({
              viewport: { width: vw, height: vh },
              deviceScaleFactor: dpr,
              userAgent: 'github-actions-playwright',
              colorScheme: 'light',
            });

            const page = await context.newPage();

            try {
              await page.goto(url, { waitUntil: 'networkidle', timeout: navTO });

              // حذف اسکرول‌بار و اختلاف‌های جزئی پیش از اسکرین‌شات
              await page.addStyleTag({ content: `
                ::-webkit-scrollbar { display: none !important; }
                html, body { overflow: hidden !important; }
              `});

              await page.waitForTimeout(waitMs);

              await page.screenshot({
                path: out,
                type: 'png',
                fullPage: false   // دقیقا 1920x1080
              });

              await browser.close();
              return true;
            } catch (e) {
              const msg = (e && e.message) ? e.message : String(e);
              console.error('Attempt #' + tryNo + ' failed: ' + msg);
              await browser.close();
              return false;
            }
          };

          let ok = false;
          for (let i = 1; i <= retries; i++) {
            ok = await attempt(i);
            if (ok) break;
            await new Promise(r => setTimeout(r, 1000 * i)); // backoff ساده
          }

          if (!ok) {
            console.error('All attempts failed.');
            process.exit(1);
          }
          EOF

      - name: Take screenshot with Playwright
        run: node scripts/snap.mjs

      - name: Sanity check size (avoid blank/too small files)
        run: |
          BYTES=$(wc -c < "$OUTPUT_PATH" | tr -d ' ')
          echo "File size: $BYTES bytes"
          test "$BYTES" -ge 20000

      - name: Commit screenshot
        shell: bash
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT_PATH"
          git commit -m "chore: refresh live screenshot (1920x1080)"
          git push

      - name: Commit only if changed
        run: |
          git fetch origin
          git checkout -B screenshots
          git add "$OUTPUT_PATH"
          if git diff --cached --quiet; then
            echo "No changes, skipping commit."
            exit 0
          fi
          git commit -m "chore: refresh live screenshot (1920x1080)"
          git push origin screenshots
