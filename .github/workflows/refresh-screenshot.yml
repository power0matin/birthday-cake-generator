name: Refresh live screenshot

on:
  schedule:
    - cron: "*/15 * * * *" # هر 15 دقیقه
  workflow_dispatch: {} # اجرا دستی
  push:
    paths:
      - ".github/workflows/refresh-screenshot.yml"

# جلوگیری از همپوشانی اجراها
concurrency:
  group: refresh-screenshot-${{ github.ref }}
  cancel-in-progress: true

# اجازهٔ push به ریپو
permissions:
  contents: write

jobs:
  shot:
    runs-on: ubuntu-latest

    env:
      # ⬇️ مقادیر قابل تنظیم ⬇️
      TARGET_URL: "https://power0matin.github.io/birthday-cake-generator/" # آدرس دموی آنلاین
      OUTPUT_PATH: "assets/birthday-cake-preview.png" # مقصد خروجی
      VIEWPORT_WIDTH: "1920" # عرض ویوپورت (Full HD)
      VIEWPORT_HEIGHT: "1080" # ارتفاع ویوپورت (Full HD)
      DEVICE_SCALE_FACTOR: "2" # اگر وضوح بالاتر خواستی = 2 (اما ابعاد فایل بزرگ‌تر می‌شود)
      WAIT_MS: "1500" # تاخیر بعد از networkidle
      NAV_TIMEOUT_MS: "45000" # تایم‌اوت ناوبری
      RETRIES: "3" # تعداد تلاش‌ها
      # ⬆️ قابل تنظیم ⬆️

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Playwright (Chromium only)
        run: |
          npm i -D playwright@^1
          npx playwright install --with-deps chromium

      - name: Ensure assets dir exists
        run: mkdir -p "$(dirname "$OUTPUT_PATH")"

      - name: Write screenshot script
        shell: bash
        run: |
          mkdir -p scripts
          cat > scripts/snap.mjs << 'EOF'
          import { chromium } from 'playwright';

          const url = process.env.TARGET_URL;
          const out = process.env.OUTPUT_PATH;

          const vw  = parseInt(process.env.VIEWPORT_WIDTH  || '1920', 10);
          const vh  = parseInt(process.env.VIEWPORT_HEIGHT || '1080', 10);
          const dpr = parseFloat(process.env.DEVICE_SCALE_FACTOR || '1');

          const waitMs    = parseInt(process.env.WAIT_MS || '1500', 10);
          const navTO     = parseInt(process.env.NAV_TIMEOUT_MS || '45000', 10);
          const retries   = parseInt(process.env.RETRIES || '3', 10);

          if (!url || !out) {
            console.error('TARGET_URL or OUTPUT_PATH missing');
            process.exit(2);
          }

          const attempt = async (tryNo) => {
            const browser = await chromium.launch({
              headless: true,
              args: [
                '--force-color-profile=srgb',  // رنگ پایدار
                `--window-size=${vw},${vh}`
              ],
            });
            const context = await browser.newContext({
              viewport: { width: vw, height: vh },
              deviceScaleFactor: dpr,
              userAgent: 'github-actions-playwright',
              colorScheme: 'light', // اگر دمو در تم تیره بهتر است، 'dark'
            });
            const page = await context.newPage();

            try {
              await page.goto(url, { waitUntil: 'networkidle', timeout: navTO });

              // حذف اسکرول‌بارها و اختلاف‌های ریزِ رندر قبل از عکس
              await page.addStyleTag({ content: `
                ::-webkit-scrollbar { display: none !important; }
                html, body { overflow: hidden !important; }
              `});

              await page.waitForTimeout(waitMs);

              // تصویر دقیقاً به اندازه‌ی ویوپورت (نه کل صفحهٔ بلند)
              await page.screenshot({
                path: out,
                type: 'png',
                fullPage: false
              });

              await browser.close();
              return true;
            } catch (e) {
              console.error(\`Attempt #\${tryNo} failed:\`, e.message);
              await browser.close();
              return false;
            }
          };

          let ok = false;
          for (let i = 1; i <= retries; i++) {
            ok = await attempt(i);
            if (ok) break;
            await new Promise(r => setTimeout(r, 1000 * i)); // backoff ساده
          }
          if (!ok) {
            console.error('All attempts failed.');
            process.exit(1);
          }
          EOF

      - name: Take screenshot with Playwright
        run: node scripts/snap.mjs

      - name: Sanity check size (avoid blank/too small files)
        run: |
          BYTES=$(wc -c < "$OUTPUT_PATH" | tr -d ' ')
          echo "File size: $BYTES bytes"
          # با فول‌اچ‌دی معمولاً خیلی بیشتر از 20KB است
          test "$BYTES" -ge 20000

      - name: Commit only if changed
        shell: bash
        run: |
          if git diff --quiet -- "$OUTPUT_PATH"; then
            echo "No changes to commit."
            exit 0
          fi
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$OUTPUT_PATH"
          git commit -m "chore: refresh live screenshot (1920x1080)"
          git push
